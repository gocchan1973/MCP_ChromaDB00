# セッション管理機能の確認手順

## 確認項目一覧

1. **セッションクッキーの確認**
2. **アプリケーションログの確認**
3. **会話履歴データベースの検査**
4. **マルチタブ/マルチブラウザテスト**
5. **セッション永続性テスト**

## 詳細手順

### 1. セッションクッキーの確認
```bash
# ブラウザの開発者ツールを開く (F12キー)
# Application/Storage/Cookiesタブを選択
# localhost:8000のクッキー一覧で、session という名前のクッキーが存在するか確認
# 値がランダムな文字列（暗号化されたセッションデータ）になっているか確認
```

### 2. アプリケーションログの確認
```bash
# サーバー起動時のログで以下のようなメッセージを確認
# 「新しいセッションを開始: 12345abc-...」のような出力があるか

# また、会話のやり取りごとに以下のようなログが出力されるか確認
# 「conversation_id: 12345abc-...でメッセージを処理中」
```

### 3. 会話履歴データベースの検査
```python
# インタラクティブシェルでデータベースの確認
python -c "
import chromadb
client = chromadb.Client()
collection = client.get_collection('conversation_history')
results = collection.query(
    query_texts=['セッション確認テスト'],
    n_results=5
)
# メタデータにconversation_idが含まれているか確認
for idx, metadata in enumerate(results['metadatas']):
    print(f'Result {idx}: conversation_id = {metadata.get(\"conversation_id\")}')
"
```

### 4. マルチタブ/マルチブラウザテスト
1. 同一ブラウザで複数タブを開き、MySisterDBにアクセス
2. 各タブで異なる会話をする
3. サーバーログを確認して、タブごとに別々のconversation_idが割り当てられているか確認
4. 別のブラウザでも同様のテストを実施

### 5. セッション永続性テスト
1. ブラウザでMySisterDBにアクセスし、会話を開始
2. サーバーログからconversation_idをメモ
3. ブラウザを閉じずに一度MySisterDBのページをリロード
4. 会話を継続し、ログを確認して同じconversation_idが使われているか確認
5. ブラウザを完全に閉じて再度アクセスした場合、新しいconversation_idが発行されるか確認
6. セッションのTTL（有効期限）を確認するため、`max_age`の設定値（例：7日間）に応じたテストを実施

## 期待される結果

- 各ブラウザセッションに一意のconversation_idが割り当てられる
- 同一セッション内では同じconversation_idが継続して使われる
- ブラウザを閉じて再アクセスしても、クッキーが保持されていれば同じセッションとして認識される
- セッション情報がデータベースに正しく記録され、会話履歴がセッションごとにグループ化される

## トラブルシューティング

- **セッションが作成されない場合**: `SessionMiddleware`が正しく設定されているか確認
- **セッションIDが記録されない場合**: リクエストオブジェクトからセッションにアクセスする方法を確認
- **セッションが継続しない場合**: クッキーの有効期限設定と保存パスを確認
