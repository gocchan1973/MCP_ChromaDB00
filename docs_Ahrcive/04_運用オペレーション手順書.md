# MySisterDB 運用オペレーション手順書

## 目次
1. [システム概要](#システム概要)
2. [主要コンポーネント](#主要コンポーネント)
3. [日常運用手順](#日常運用手順)
4. [開発会話学習の運用](#開発会話学習の運用)
5. [メンテナンス手順](#メンテナンス手順)
6. [トラブルシューティング](#トラブルシューティング)
7. [リリース手順](#リリース手順)
8. [継続改善プロセス](#継続改善プロセス)

---

## システム概要

ChromaDB RAGシステム(MySisterDB)は、会話の文脈を保持し、過去の対話履歴を活用してより自然で一貫性のある応答を実現するシステムです。さらに、GitHub Copilotとの開発会話を学習データとして活用し、開発知識ベースを構築します。

### 目的
- 文脈を考慮した応答生成
- 過去の対話履歴の活用
- 開発知識の蓄積と再利用
- 自動学習による継続的改善

### スコープ
- 会話履歴の構造化と管理
- コンテキスト考慮型検索システム
- 自動学習・更新機能
- 運用監視・メンテナンス体制
- GitHub Copilot開発会話の学習・活用システム

**参照元:** `conversation_improvement_operations.md`

---

## 主要コンポーネント

### 1. 会話履歴管理システム
```python
ConversationTurn = {
    "id": str,                    # 各ターンの一意ID
    "timestamp": datetime,        # 対話時刻
    "user_input": str,           # ユーザー入力
    "assistant_response": str,    # アシスタント応答
    "context_used": List[str],   # 使用したRAGコンテキスト
    "persona": str,              # 使用ペルソナ
    "conversation_id": str,      # セッションID
    "quality_score": float,      # 応答品質スコア
    "conversation_type": str,    # 会話種別
    "development_context": dict  # 開発コンテキスト
}
```

### 2. コンテキスト考慮検索システム
- `utils/context_extractor.py`: 直近会話からの関連トピック抽出
- `rag_gemini.py`: 動的検索クエリ生成
- `utils/dev_knowledge_search.py`: 開発知識検索機能

### 3. 自動学習システム
- `utils/auto_learning_scheduler.py`: 定期的なベクトルDB更新
- `conversation_summary_tool.py`: 会話要約の自動実行
- `utils/quality_monitor.py`: 品質管理・データクレンジング

### 4. 開発会話学習システム
- `utils/dev_conversation_capture.py`: 開発会話の自動分類・構造化
- `utils/dev_conversation_classifier.py`: 技術的知見の抽出・インデックス化
- `utils/dev_knowledge_manager.py`: 開発パターンの学習・推奨機能

**参照元:** `conversation_improvement_operations.md`

---

## 日常運用手順

### 1. システム起動手順
```bash
# 1. 環境変数の確認
source .env

# 2. サーバー起動
cd web_local
python main.py

# 3. ログ確認
tail -f logs/mysisterdb.log
```

### 2. 定期チェック項目
- ChromaDBの接続状態確認
- ログファイルのエラーチェック
- ディスク使用量の確認
- メモリ使用状況の監視

### 3. バックアップ手順
```bash
# 日次自動バックアップ設定
0 1 * * * /path/to/backup_script.sh >> /path/to/backup.log 2>&1

# 手動バックアップ実行
./backup_script.sh manual_backup_$(date +%Y%m%d)
```

### 4. 日次レポート確認
- 利用統計の確認
- エラー発生率の確認
- パフォーマンスメトリクスの確認
- ユーザーフィードバックの確認

**参照元:** `conversation_improvement_operations.md`

---

## 開発会話学習の運用

### 1. 日常的な開発会話学習

#### 朝の開発セッション（9:00 AM）
1. **前日の開発会話レビュー**
   ```python
   # 前日の開発会話サマリー確認
   python utils/dev_knowledge_manager.py --summary yesterday
   ```

2. **今日の開発予定と関連知識の確認**
   ```python
   # 予定作業に関連する過去の知見を検索
   python utils/dev_knowledge_search.py --query "今日の開発タスク" --category implementation
   ```

#### 開発作業中
1. **リアルタイム知識検索**
   - エラー発生時の自動類似問題検索
   - 新機能実装時の過去パターン参照
   - コードレビュー時の品質改善提案

2. **会話品質の向上**
   - 技術的文脈の保持
   - 過去の解決策の参照
   - 段階的な問題解決アプローチ

#### 夕方の振り返り（6:00 PM）
1. **1日の開発会話分析**
   ```python
   # 今日の開発会話を分析・分類
   python utils/dev_conversation_analyzer.py --analyze today
   ```

2. **学習データの品質確認**
   ```python
   # 自動分類の精度確認
   python utils/dev_knowledge_manager.py --quality-check
   ```

### 2. 週次開発知識管理

#### 毎週金曜日（4:00 PM）
1. **週次開発サマリー生成**
   ```python
   # 一週間の開発活動をサマリー化
   python utils/dev_conversation_summary.py --weekly-report
   ```

2. **技術スタック使用状況分析**
   ```python
   # 使用技術の傾向分析
   python utils/tech_usage_analyzer.py --week
   ```

3. **ナレッジベースの最適化**
   ```python
   # 重複データの統合、古いデータのアーカイブ
   python utils/dev_knowledge_optimizer.py --weekly-optimization
   ```

### 3. 月次知識ベース管理

#### 毎月末（最終営業日）
1. **月次開発レポート**
   - 解決した問題のカテゴリ分析
   - よく使用される技術スタックの特定
   - 開発効率の改善度測定

2. **ナレッジベースのメンテナンス**
   - 古くなった技術情報の更新
   - 新しい技術トレンドの反映
   - 検索精度の改善

**参照元:** `conversation_improvement_operations.md`

---

## メンテナンス手順

### 1. ChromaDB メンテナンス

#### インデックス最適化
```bash
# ChromaDBのインデックス最適化
python maintenance/chromadb_optimizer.py --optimize-indexes

# 不要データのクリーンアップ
python maintenance/chromadb_optimizer.py --cleanup
```

#### データ一貫性チェック
```bash
# データ整合性の検証
python maintenance/data_consistency_check.py

# 問題の修正
python maintenance/data_fix.py --auto-repair
```

### 2. ログローテーション
```bash
# ログローテーション設定の確認
cat /etc/logrotate.d/mysisterdb

# 手動ログローテーション実行
logrotate -f /etc/logrotate.d/mysisterdb
```

### 3. パフォーマンスチューニング
```bash
# キャッシュの最適化
python maintenance/cache_optimizer.py

# メモリ使用量の分析
python maintenance/memory_profiler.py
```

### 4. セキュリティ対策
- 依存ライブラリの更新
- アクセス権限の見直し
- 潜在的な脆弱性のスキャン

**参照元:** `conversation_improvement_operations.md`

---

## トラブルシューティング

### 1. 一般的な問題と解決策

#### ChromaDB 接続エラー
```bash
# 接続テスト
python -c "import chromadb; client = chromadb.Client(); print('接続OK')"

# 再起動
systemctl restart chromadb
```

#### メモリ使用量過多
```bash
# メモリ使用状況確認
ps -o pid,user,%mem,command ax | sort -b -k3 -r | head -n 10

# キャッシュクリア
python maintenance/clear_cache.py
```

#### 応答遅延
```bash
# インデックス状態確認
python diagnostics/index_status.py

# クエリ最適化
python diagnostics/query_optimizer.py
```

### 2. ログ解析
```bash
# エラーログの抽出
grep -i "error\|exception\|warning" logs/mysisterdb.log | tail -n 100

# 特定のエラーパターン分析
python diagnostics/log_analyzer.py --pattern "connection refused"
```

### 3. 復旧手順
```bash
# バックアップからの復元
./restore_script.sh backup_20250101

# データ整合性チェック
python diagnostics/consistency_check.py
```

**参照元:** `conversation_improvement_operations.md`

---

## リリース手順

### 1. 事前準備チェックリスト
- [ ] 開発環境での全機能テスト完了
- [ ] データベースバックアップ取得
- [ ] 設定ファイルの本番環境用調整
- [ ] ログ監視体制の確立
- [ ] ロールバック手順の確認

### 2. 段階的リリース手順

#### Step 1: データ構造拡張の適用
```bash
# 1. バックアップ作成
cp -r MySisterDB MySisterDB_backup_$(date +%Y%m%d)

# 2. 機能コードのデプロイ
git checkout phase1-conversation-structure
cp web_local/main.py /path/to/production/

# 3. システム再起動
systemctl restart mysisterdb

# 4. 動作確認
curl -X POST http://localhost:5000/chat -d "{'message': 'テストメッセージ'}"
```

#### Step 2: 検索機能の拡張
```bash
# 1. コンテキスト検索機能のデプロイ
git checkout phase2-context-search
cp utils/context_extractor.py /path/to/production/utils/
cp rag_gemini.py /path/to/production/

# 2. システム再起動・動作確認
systemctl restart mysisterdb
```

#### Step 3: スケジューラ・監視の拡張
```bash
# 1. 自動化機能のデプロイ
git checkout phase3-automation
cp utils/auto_learning_scheduler.py /path/to/production/utils/
cp utils/quality_monitor.py /path/to/production/utils/

# 2. スケジューラの設定
crontab -e
# 以下を追加:
# 0 2 * * * cd /path/to/production && python -m utils.auto_learning_scheduler
```

#### Step 4: 開発会話学習機能の追加
```bash
# 1. 開発会話学習機能のデプロイ
git checkout phase4-dev-learning
cp utils/dev_conversation_capture.py /path/to/production/utils/
cp utils/dev_knowledge_search.py /path/to/production/utils/

# 2. ChromaDBに開発知識用コレクション作成
python -c "
import chromadb
client = chromadb.Client()
client.create_collection('development_knowledge')
print('開発知識コレクション作成完了')
"

# 3. システム再起動・動作確認
systemctl restart mysisterdb
```

**参照元:** `conversation_improvement_operations.md`

---

## 継続改善プロセス

### 1. 定期レビュー
- **週次**: 技術メトリクス確認
- **月次**: 全体パフォーマンス評価
- **四半期**: システム全体の見直し

### 2. フィードバック収集
```python
# utils/feedback_collector.py
def collect_user_feedback():
    # ユーザーフィードバックの収集
    # 満足度調査の実施
    # 改善提案の整理
    pass
```

### 3. 改善サイクル
1. **Plan**: メトリクス分析による改善点特定
2. **Do**: 小規模な改善実装
3. **Check**: 効果測定
4. **Act**: 成功した改善の本格展開

### 4. 開発会話学習による継続改善

#### 自動学習サイクル
1. **収集**: 日々の開発会話を自動キャプチャ
2. **分析**: 技術トレンド、問題パターンの分析
3. **学習**: ナレッジベースの更新・最適化
4. **適用**: 新しい開発課題への知見活用

#### 開発知識の進化
```python
# utils/knowledge_evolution.py
class KnowledgeEvolution:
    def evolve_knowledge_base(self):
        """ナレッジベースの進化的改善"""
        # 使用頻度の低い古い知識のアーカイブ
        self.archive_obsolete_knowledge()
        
        # 新しい技術トレンドの検出・統合
        self.integrate_new_tech_trends()
        
        # 解決パターンの一般化・抽象化
        self.generalize_solution_patterns()
        
        # 知識間の関連性強化
        self.strengthen_knowledge_connections()
```

**参照元:** `conversation_improvement_operations.md`

---

## 現実的な運用パターン

### 1. 【推奨】オンデマンド運用
**特徴**: 必要な時だけ手動実行
**メリット**: シンプル、負荷なし、確実にコントロール可能
**デメリット**: 忘れる可能性、手動工数

#### 基本的な使用フロー
```bash
# 1. 普段の質問・対話
python rag_gemini.py
# → 普通にAIと会話

# 2. 会話が有益だった時のみ学習
python conversation_summary_tool.py
# → 手動で会話を要約・学習

# 3. 新しい学習データ追加時のみ
python rag_system.py
# → 2. ドキュメント学習（必要時のみ）
```

### 2. 【オプション】自動化運用
**特徴**: 一部を自動化、重要な部分は手動
**メリット**: 効率的、忘れ防止
**デメリット**: 設定が必要

#### 最小限の自動化
```bash
# 毎日深夜に会話履歴バックアップのみ自動化
0 2 * * * cp -r f:/副業/VSC_WorkSpace/MySisterDB/history/ f:/副業/VSC_WorkSpace/MySisterDB/history_backup/$(date +\%Y\%m\%d)/

# その他は手動実行
```

### 3. 【上級者向け】フル自動運用
**特徴**: ほぼ全て自動化
**メリット**: 完全に手間なし
**デメリット**: 設定複雑、デバッグ困難

---

## 推奨運用パターン（初心者向け）

### 日常運用（手動・必要時のみ）

#### 普段の使用
```bash
# 1. 質問したい時
cd f:/副業/VSC_WorkSpace/MySisterDB
python rag_gemini.py

# 2. Webインターフェースを使いたい時
cd web_local
python main.py
# → ブラウザで http://localhost:8000
```

#### 会話が価値ある内容だった時のみ（週1-2回程度）
```bash
# 有益な会話を手動で学習
python conversation_summary_tool.py
# → 「2. 直接入力」で会話内容を貼り付け
```

#### 新しい資料を追加したい時のみ（月1回程度）
```bash
# 新しいドキュメントを学習
python rag_system.py
# → 「2. ドキュメント学習」
```

### トラブル時のみ実行
```bash
# 何か調子が悪い時のみ
python rag_system.py
# → 「4. コレクション確認」

# バックアップが欲しい時のみ
python rag_system.py
# → 「5. コレクション複製」
```

### 自動化は必要最小限
```bash
# 唯一の自動化：日次バックアップ（オプション）
# Windows タスクスケジューラで設定
xcopy "f:\副業\VSC_WorkSpace\MySisterDB\chromadb_data" "f:\副業\VSC_WorkSpace\MySisterDB\chromadb_data_backup\%date%" /E /I
```

## メンテナンス（オプション・推奨頻度）

| 作業 | 頻度 | 必要性 | 自動化 |
|------|------|--------|--------|
| **質問・対話** | 日常 | 必須 | なし |
| **有益会話の学習** | 週1-2回 | 推奨 | なし |
| **新資料追加** | 月1回 | 必要時のみ | なし |
| **バックアップ** | 週1回 | 推奨 | 可能 |
| **コレクション確認** | 月1回 | 問題時のみ | なし |
| **古いデータ整理** | 半年1回 | オプション | なし |

---

**文書管理情報**
- **作成日**: 2025年5月
- **最終更新**: 2025年6月2日
- **次回見直し**: 2025年9月
- **承認者**: 博多のごっちゃん
- **文書バージョン**: v1.1
