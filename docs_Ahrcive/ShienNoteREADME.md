# 訪問介護 業務支援ノートのデータ処理ツール
 業務アプリ

## 概要
このアプリは、訪問介護業務における支援ノート（PDFまたはExcel）と業務データ（Excel）の比較処理を行うためのツールです。以下の機能を提供します：
- 支援ノート（PDF/Excel）と業務データ（Excel）のアップロード（ドラッグアンドドロップ対応）
- データのクレンジングと処理
- 処理済みデータのダウンロード
- アップロード済みファイルのリスト表示
- 将来、支援ノートのPDF形式をExcel形式に変換する機能

## 構成
- **フロントエンド**: Node.js, EJS, HTML, CSS, JavaScript
- **バックエンド**: Python, Flask, Flask-CORS
- **データ処理**: pandas, openpyxl, xlrd, xlsxwriter, pdfminer.six

## セットアップ
### 必要条件
- Node.js
- Python 3.x
- 必要なPythonライブラリ: Flask, pandas, openpyxl, xlrd, xlsxwriter, pdfminer.six, Flask-CORS

### インストール手順
1. フロントエンド:
   ```bash
   cd frontend
   npm install
   ```
2. バックエンド:
   ```bash
   cd backend
   pip install -r requirements.txt
   ```
   (もし `requirements.txt` が最新でない場合、個別にインストール):
   ```bash
   pip install Flask pandas openpyxl xlrd xlsxwriter pdfminer.six Flask-CORS
   ```

## 使用方法
1. バックエンドサーバーを起動:
   ```bash
   cd backend
   python app.py
   ```
   (サーバーは `http://<ローカルIPアドレス>:5000` で起動します)
2. フロントエンドサーバーを起動:
   ```bash
   cd frontend
   node index.js
   ```
   (サーバーは `http://<ローカルIPアドレス>:3000` で起動します)
3. ブラウザで `http://<ローカルIPアドレス>:3000` にアクセスします。

## 他の端末からのアクセス方法

### IPアドレスの設定
このアプリケーションは、デフォルトで `127.0.0.1` (localhost) を使用するように設定されていますが、他の端末からアクセスする場合は以下の設定が必要です：

1. **バックエンドサーバー設定**:
   - `backend/app.py` ファイルでは、ローカルIPアドレスが自動的に取得され、適用されます。
   - サーバー起動時にコンソールに表示されるIPアドレスを確認してください。

2. **フロントエンド側の設定**:
   - `frontend/public/config.js` および各JavaScriptファイル内の `localIp` または `BACKEND_URL` の値を、
     使用するマシンの実際のIPアドレスに変更してください。
   - 例: `const localIp = '192.168.1.100';` または `const BACKEND_URL = 'http://192.168.1.100:5000';`

3. **動作確認**:
   - 設定変更後、アプリケーションを再起動し、`http://<実際のIPアドレス>:3000` にアクセスしてください。
   - 同一ネットワーク上の他の端末からも同じURLでアクセス可能になります。

### 注意点
- ファイアウォールの設定で、使用するポート（3000および5000）がブロックされていないことを確認してください。
- 本番環境で使用する場合は、適切なセキュリティ設定を行い、SSL/TLS証明書の導入を検討してください。
- 各デバイスで正常に表示されない場合は、ブラウザのキャッシュをクリアしてください。
- 利用者名の抽出改善（D列の文頭から13文字以降を利用者名として抽出）
- 出力ファイルの拡張子を常に.xlsxに統一し、互換性を向上
- Excelファイル生成処理の強化（複数のバックアップ保存方法を実装）
- Excelファイル読み込み時に、時刻や利用者IDの列が数値として解釈されないように、データ型を文字列として明示的に指定
- Excelファイル出力時に、全ての列に対して文字列形式を適用

## 機能  
- **ファイルアップロード**: 
支援ノート（PDF/Excel）と業務データ（Excel）をドラッグアンドドロップで複数ファイル追加・削除してアップロード。
- **一連ファイル処理**: 
アップロードされた複数ファイル同時処理 (`/process-files` エンドポイント)。将来、PDFファイルをExcel形式にも対応。
- **データ処理**: 
クレンジングと最終ファイル生成 (`/process` エンドポイント、現在は固定ファイル名で動作)。
- **ダウンロード**: 
処理済みファイルをダウンロード (`/download` エンドポイント、現在は固定ファイル名で動作)。
- **ファイルリスト表示**: 
アップロード済みファイルを確認 (`/uploaded-files` エンドポイント)。
- **削除機能**:
  - 個別ファイル削除: 各ファイル項目の横に削除ボタンを表示し、ファイルを個別に削除可能
  - 全ファイル削除: アップロードファイル一覧と処理済みファイル一覧で「全て削除」ボタンによる一括削除
  - 削除前確認: 削除操作前に確認ダイアログを表示し、誤操作防止

## ディレクトリ構成
```
.
├── backend
│   ├── app.py
│   ├── data_processing.py
│   ├── pdf_processing.py  # PDF処理用スクリプト
│   ├── requirements.txt
│   └── data/              # ルールファイル、テンプレート等
├── frontend
│   ├── index.js
│   ├── package.json
│   ├── package-lock.json
│   ├── public/
│   │   ├── style.css
│   │   ├── script.js
│   │   ├── config.js      # バックエンドURL設定ファイル
│   │   ├── uploaded_files.js
│   │   ├── processed_files.js
│   │   └── comparison.js
│   └── views/
│       ├── compare.ejs
│       └── index.ejs      # トップページ
├── uploads/               # アップロードされたファイル (自動生成)
├── processed/             # 処理済みファイル (自動生成)
└── README.md
```

## 注意事項
- このアプリは開発環境用です。本番環境で使用する場合は適切なセキュリティ設定を行ってください。
- バックエンドとフロントエンドは異なるポートで動作するため、CORS設定が必要です（実装済み）。
- `uploads/` および `processed/` ディレクトリは、ファイルアップロードや処理時に自動的に作成されます。
- 複数端末からアクセスする場合、ネットワークの設定によっては通信がブロックされる可能性があります。適宜ファイアウォール設定を調整してください。
- 同一ネットワーク内のみでのアクセスを推奨します。インターネット経由でのアクセスには追加のセキュリティ設定が必要です。
- Excelファイルへのフィルター適用には `xlsxwriter` モジュールが必須です。インストールされていない場合は `pip install xlsxwriter` でインストールしてください。

## 最新の改善内容（2025年5月16日更新）

### データ処理の安定性向上
- **Excelファイル読み込み時の堅牢性向上**
  - すべての列を文字列型として読み込むためのコンバーターを設定
  - 読み込みエラー時のフォールバック処理を追加
  - 整数型や浮動小数点型の値も適切に処理できるよう改善

### データ変換機能の強化
- **専用データ変換関数の実装**
  - 利用者ID: 10桁のゼロ埋め文字列に統一（例：「0000123456」）
  - 時刻: 4桁のゼロ埋め文字列に統一（例：「0830」）
  - 日付: 8桁のゼロ埋め文字列に統一（例：「20250407」）
  - 空の値: すべて「null」文字列に統一

- **支援ノートクレンジング処理**
  - G列から【】で囲まれたテキストを抽出してF列に格納
  - G列からは【】で囲まれたテキストを削除
  - 出力Excelファイルの全シートにA列～G列のフィルターを自動適用
  - Excelファイル読み込み時に、時刻や利用者IDの列が数値として解釈されないように、データ型を文字列として明示的に指定
  - Excelファイル出力時に、全ての列に対して文字列形式を適用

### 出力Excelファイルの可読性向上
- **シート名の日本語化**
  - 「Support」→「支援ノート元データ」
  - 「Performance」→「実績元データ」
  - 「ノート有実無」「実有ノート無」（変更なし）

- **メタデータ情報の追加**
  - 「ノート有実無」と「実有ノート無」シートの1行目J列にデータ数を表示
  - 差分理由のメタデータ列を追加して差分内容を明確化
  - 例：「利用者ID: 0000123456, 日付: 20250407, 時刻: 0830のデータが実績に存在しません」

## 最新の改善内容（2025年5月20日更新）

### 実績データの前処理機能強化
- **日付空欄埋め込み前処理機能の追加**
  - 実績データ内の空の日付フィールドに直前の有効な日付を自動的に埋め込む処理を実装
  - XLSファイルからXLSXファイルへの変換処理を強化し、データ損失を防止
  - ファイル読み込み前後の行数を詳細に検証し、データの完全性を確保

### 日付・時刻検出ロジックの拡張
- **多様な日付パターン対応**
  - 単純な数値形式から完全な日付形式まで、複数のパターンを検出可能に改善
  - MM/DD、yyyy/MM/dd、単一の数字など様々な形式に対応
  - 空の日付フィールドが検出された場合のフォールバック処理を実装

- **時刻情報抽出の強化**
  - 時間範囲表記（例：「04:30～05:00」）からの時刻抽出機能を追加
  - 全角数字を含む時刻表記にも対応
  - 数値のみの形式やその他の特殊パターンも適切に処理

### データ品質管理機能の追加
- **詳細な統計情報表示**
  - 処理結果に利用者別・日付別の集計情報を自動表示
  - 元データと処理後のデータの行数比較による抽出率を計算
  - データ品質チェックによる警告メッセージの表示機能

- **データ品質チェック機能**
  - 低抽出率や利用者情報未検出などに対する警告表示
  - 日付別データ分布の偏りチェック
  - 処理結果の詳細なサマリー情報の提供
